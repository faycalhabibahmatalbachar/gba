<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fix Cart Items Trigger - Solution Compl√®te</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .sql-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .results {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix D√©finitif Cart Items - last_updated</h1>
        
        <div id="status"></div>
        
        <div class="sql-content" id="sqlContent">
-- Solution compl√®te pour le probl√®me last_updated dans cart_items

-- 1. V√©rifier et ajouter la colonne last_updated si elle n'existe pas
DO $$ 
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns 
        WHERE table_name = 'cart_items' 
        AND column_name = 'last_updated'
    ) THEN
        ALTER TABLE cart_items 
        ADD COLUMN last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW();
    END IF;
END $$;

-- 2. Supprimer les triggers existants
DROP TRIGGER IF EXISTS update_cart_items_updated_at ON cart_items;
DROP TRIGGER IF EXISTS cart_items_last_updated_trigger ON cart_items;
DROP FUNCTION IF EXISTS update_cart_items_updated_at();
DROP FUNCTION IF EXISTS update_cart_items_last_updated();

-- 3. Cr√©er une nouvelle fonction pour g√©rer last_updated
CREATE OR REPLACE FUNCTION handle_cart_items_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    -- Toujours mettre √† jour last_updated lors d'un UPDATE
    NEW.last_updated = NOW();
    -- S'assurer que last_updated existe lors d'un INSERT
    IF TG_OP = 'INSERT' AND NEW.last_updated IS NULL THEN
        NEW.last_updated = NOW();
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 4. Cr√©er le trigger BEFORE pour intercepter avant l'√©criture
CREATE TRIGGER cart_items_timestamp_trigger
BEFORE INSERT OR UPDATE ON cart_items
FOR EACH ROW
EXECUTE FUNCTION handle_cart_items_timestamp();

-- 5. Mettre √† jour les enregistrements existants
UPDATE cart_items 
SET last_updated = COALESCE(last_updated, NOW())
WHERE last_updated IS NULL;
        </div>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="executeFix()">üöÄ Ex√©cuter le Fix Complet</button>
            <button onclick="testCart()">üß™ Tester l'Ajout au Panier</button>
            <button onclick="checkColumns()">üìä V√©rifier les Colonnes</button>
        </div>
        
        <div id="results" class="results"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uvlrgwdbjegoavjfdrzb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bHJnd2RiamVnb2F2amZkcnpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1NjU1MzgsImV4cCI6MjA0ODE0MTUzOH0.6ViPt2-gvMGnCKKzyIa0C6JRM4HQQloYLknpF0LNqX4';

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = message;
        }

        async function executeFix() {
            showStatus('Ex√©cution du fix en cours...', 'info');
            
            try {
                const sql = document.getElementById('sqlContent').textContent;
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/exec_sql`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: sql })
                });

                if (!response.ok) {
                    // Alternative: ex√©cuter les commandes une par une
                    showStatus('Tentative d\'ex√©cution alternative...', 'warning');
                    await executeAlternative();
                } else {
                    showStatus('Fix appliqu√© avec succ√®s! ‚úÖ', 'success');
                    await checkColumns();
                }
            } catch (error) {
                console.error('Erreur:', error);
                showStatus(`Erreur: ${error.message}`, 'error');
            }
        }

        async function executeAlternative() {
            try {
                // V√©rifier d'abord si la colonne existe
                const checkResponse = await fetch(`${SUPABASE_URL}/rest/v1/cart_items?select=*&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                const data = await checkResponse.json();
                
                if (checkResponse.ok) {
                    showStatus('La table cart_items est accessible. V√©rification de la structure...', 'info');
                    
                    // Essayer d'ajouter un article test sans last_updated
                    const testInsert = await fetch(`${SUPABASE_URL}/rest/v1/cart_items`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            user_id: 'test-user-' + Date.now(),
                            product_id: 'test-product',
                            quantity: 1,
                            price: 10
                        })
                    });

                    if (testInsert.ok) {
                        showStatus('Le fix semble d√©j√† appliqu√©! ‚úÖ', 'success');
                    } else {
                        const errorText = await testInsert.text();
                        showStatus(`Probl√®me d√©tect√©: ${errorText}. Appliquez le script SQL manuellement dans Supabase.`, 'warning');
                    }
                }
            } catch (error) {
                showStatus(`Erreur alternative: ${error.message}`, 'error');
            }
        }

        async function testCart() {
            showStatus('Test d\'ajout au panier...', 'info');
            
            try {
                // Cr√©er un article test
                const testItem = {
                    user_id: 'test-' + Date.now(),
                    product_id: 'test-product-' + Date.now(),
                    quantity: 1,
                    price: 99.99
                };

                const response = await fetch(`${SUPABASE_URL}/rest/v1/cart_items`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(testItem)
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('Test r√©ussi! Article ajout√© sans erreur ‚úÖ', 'success');
                    
                    // Nettoyer l'article test
                    if (result[0] && result[0].id) {
                        await fetch(`${SUPABASE_URL}/rest/v1/cart_items?id=eq.${result[0].id}`, {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        });
                    }
                } else {
                    const error = await response.text();
                    if (error.includes('last_updated')) {
                        showStatus('‚ö†Ô∏è L\'erreur last_updated persiste. Ex√©cutez le fix d\'abord.', 'error');
                    } else {
                        showStatus(`Erreur: ${error}`, 'error');
                    }
                }
            } catch (error) {
                showStatus(`Erreur test: ${error.message}`, 'error');
            }
        }

        async function checkColumns() {
            showStatus('V√©rification de la structure de la table...', 'info');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/cart_items?select=*&limit=0`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'count=exact'
                    }
                });

                if (response.ok) {
                    const contentRange = response.headers.get('content-range');
                    const columns = response.headers.get('content-location');
                    
                    let html = '<h3>‚úÖ Table cart_items accessible</h3>';
                    html += '<div class="info status">La table est accessible. Pour voir la structure compl√®te, utilisez l\'√©diteur SQL de Supabase.</div>';
                    
                    document.getElementById('results').innerHTML = html;
                    showStatus('V√©rification termin√©e', 'success');
                }
            } catch (error) {
                showStatus(`Erreur v√©rification: ${error.message}`, 'error');
            }
        }

        // Auto-check au chargement
        window.onload = () => {
            showStatus('Pr√™t √† ex√©cuter le fix d√©finitif', 'info');
        };
    </script>
</body>
</html>
