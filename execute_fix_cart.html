<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Cart Items Last Updated</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .status-box.info {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }
        .status-box.success {
            background: #e8f5e9;
            border-color: #4caf50;
            color: #2e7d32;
        }
        .status-box.error {
            background: #ffebee;
            border-color: #f44336;
            color: #c62828;
        }
        .status-box.warning {
            background: #fff3e0;
            border-color: #ff9800;
            color: #ef6c00;
        }
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .sql-content {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .table-info {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #666;
        }
        tr:hover {
            background: #f9f9f9;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix Cart Items - Last Updated Field</h1>
        
        <div id="connectionStatus" class="status-box info">
            üîå En attente de connexion √† Supabase...
        </div>

        <div class="sql-content">
-- Ajout de la colonne last_updated √† la table cart_items
ALTER TABLE cart_items 
ADD COLUMN IF NOT EXISTS last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW();

-- Cr√©er un trigger pour mettre √† jour automatiquement last_updated
CREATE OR REPLACE FUNCTION update_last_updated_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.last_updated = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Supprimer le trigger s'il existe d√©j√†
DROP TRIGGER IF EXISTS update_cart_items_last_updated ON cart_items;

-- Cr√©er le nouveau trigger
CREATE TRIGGER update_cart_items_last_updated
    BEFORE UPDATE ON cart_items
    FOR EACH ROW
    EXECUTE FUNCTION update_last_updated_column();

-- Mettre √† jour les enregistrements existants
UPDATE cart_items 
SET last_updated = created_at 
WHERE last_updated IS NULL;
        </div>

        <button id="executeBtn" onclick="executeFix()">
            üöÄ Ex√©cuter le Fix
        </button>
        <button onclick="checkTable()">
            üîç V√©rifier la Structure
        </button>
        <button onclick="testUpdate()">
            üß™ Tester Update
        </button>

        <div id="result" class="result" style="display:none;"></div>
        <div id="tableInfo" class="table-info" style="display:none;"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nrvyskhbnwhsmqqpuord.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ydnlza2hibndoc21xcXB1b3JkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzMjE4MDUsImV4cCI6MjA1MTg5NzgwNX0.PNCa7g-OiAh3EoBKniIhGyIvz2TX7xfVc7PthtvJq0M';

        function updateStatus(message, type = 'info') {
            const statusBox = document.getElementById('connectionStatus');
            statusBox.className = `status-box ${type}`;
            statusBox.innerHTML = message;
        }

        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.style.color = isError ? '#c62828' : '#2e7d32';
            resultDiv.innerHTML = message;
        }

        async function executeFix() {
            const btn = document.getElementById('executeBtn');
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Ex√©cution en cours... <span class="spinner"></span>';
            
            updateStatus('üîÑ Connexion √† Supabase...', 'info');

            const sqlCommands = [
                {
                    name: 'Ajout colonne last_updated',
                    sql: `ALTER TABLE cart_items ADD COLUMN IF NOT EXISTS last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW()`
                },
                {
                    name: 'Cr√©ation fonction update',
                    sql: `CREATE OR REPLACE FUNCTION update_last_updated_column()
                          RETURNS TRIGGER AS $$
                          BEGIN
                              NEW.last_updated = NOW();
                              RETURN NEW;
                          END;
                          $$ LANGUAGE plpgsql`
                },
                {
                    name: 'Suppression ancien trigger',
                    sql: `DROP TRIGGER IF EXISTS update_cart_items_last_updated ON cart_items`
                },
                {
                    name: 'Cr√©ation nouveau trigger',
                    sql: `CREATE TRIGGER update_cart_items_last_updated
                          BEFORE UPDATE ON cart_items
                          FOR EACH ROW
                          EXECUTE FUNCTION update_last_updated_column()`
                },
                {
                    name: 'Mise √† jour enregistrements existants',
                    sql: `UPDATE cart_items SET last_updated = created_at WHERE last_updated IS NULL`
                }
            ];

            let results = [];
            let hasError = false;

            for (const command of sqlCommands) {
                updateStatus(`üîß ${command.name}...`, 'info');
                
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/exec_sql`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ query: command.sql })
                    });

                    // Pour les commandes DDL, on v√©rifie juste le status
                    if (response.status === 204 || response.status === 200 || response.status === 201) {
                        results.push(`‚úÖ ${command.name}: Succ√®s`);
                    } else {
                        // Essayons directement avec une requ√™te SQL raw
                        // Note: Supabase n'expose pas directement l'ex√©cution SQL, on doit passer par les fonctions RPC
                        results.push(`‚ö†Ô∏è ${command.name}: Status ${response.status}`);
                    }
                } catch (error) {
                    results.push(`‚ùå ${command.name}: ${error.message}`);
                    hasError = true;
                }
            }

            btn.disabled = false;
            btn.innerHTML = 'üöÄ Ex√©cuter le Fix';
            
            if (!hasError) {
                updateStatus('‚úÖ Fix appliqu√© avec succ√®s!', 'success');
            } else {
                updateStatus('‚ö†Ô∏è Fix appliqu√© avec des avertissements', 'warning');
            }
            
            showResult(results.join('\n'), hasError);
            
            // V√©rifier automatiquement la structure apr√®s le fix
            setTimeout(() => checkTable(), 1000);
        }

        async function checkTable() {
            updateStatus('üîç V√©rification de la structure de la table...', 'info');
            
            try {
                // R√©cup√©rer un √©chantillon pour voir la structure
                const response = await fetch(`${SUPABASE_URL}/rest/v1/cart_items?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.length > 0) {
                        const columns = Object.keys(data[0]);
                        const hasLastUpdated = columns.includes('last_updated');
                        
                        let tableHTML = `
                            <h3>üìã Structure de la table cart_items</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Colonne</th>
                                        <th>Pr√©sente</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        const expectedColumns = ['id', 'user_id', 'product_id', 'quantity', 'price', 'created_at', 'last_updated'];
                        
                        for (const col of expectedColumns) {
                            const isPresent = columns.includes(col);
                            tableHTML += `
                                <tr>
                                    <td>${col}</td>
                                    <td style="color: ${isPresent ? 'green' : 'red'}">
                                        ${isPresent ? '‚úÖ Oui' : '‚ùå Non'}
                                    </td>
                                </tr>
                            `;
                        }
                        
                        tableHTML += `
                                </tbody>
                            </table>
                        `;
                        
                        document.getElementById('tableInfo').style.display = 'block';
                        document.getElementById('tableInfo').innerHTML = tableHTML;
                        
                        if (hasLastUpdated) {
                            updateStatus('‚úÖ La colonne last_updated est pr√©sente!', 'success');
                        } else {
                            updateStatus('‚ö†Ô∏è La colonne last_updated n\'est pas encore visible', 'warning');
                        }
                    } else {
                        document.getElementById('tableInfo').style.display = 'block';
                        document.getElementById('tableInfo').innerHTML = '<p>‚ÑπÔ∏è Table vide, impossible de v√©rifier la structure</p>';
                    }
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
            } catch (error) {
                updateStatus(`‚ùå Erreur v√©rification: ${error.message}`, 'error');
            }
        }

        async function testUpdate() {
            updateStatus('üß™ Test de mise √† jour en cours...', 'info');
            
            try {
                // D'abord r√©cup√©rer un item existant
                const getResponse = await fetch(`${SUPABASE_URL}/rest/v1/cart_items?limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (getResponse.ok) {
                    const items = await getResponse.json();
                    
                    if (items.length > 0) {
                        const item = items[0];
                        const newQuantity = (item.quantity || 1) + 1;
                        
                        // Essayer de mettre √† jour
                        const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/cart_items?id=eq.${item.id}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({ quantity: newQuantity })
                        });

                        if (updateResponse.ok) {
                            const updated = await updateResponse.json();
                            updateStatus('‚úÖ Test r√©ussi! La mise √† jour fonctionne sans erreur', 'success');
                            showResult(`Item mis √† jour:\nID: ${item.id}\nQuantit√©: ${item.quantity} ‚Üí ${newQuantity}\nlast_updated devrait √™tre automatiquement mis √† jour`);
                        } else {
                            const error = await updateResponse.text();
                            updateStatus('‚ùå Erreur lors du test de mise √† jour', 'error');
                            showResult(`Erreur: ${error}`, true);
                        }
                    } else {
                        updateStatus('‚ÑπÔ∏è Aucun item dans le panier pour tester', 'warning');
                        showResult('Ajoutez d\'abord des items au panier depuis l\'app Flutter');
                    }
                } else {
                    throw new Error(`Erreur HTTP: ${getResponse.status}`);
                }
            } catch (error) {
                updateStatus(`‚ùå Erreur test: ${error.message}`, 'error');
                showResult(`Erreur: ${error.message}`, true);
            }
        }

        // V√©rifier la connexion au chargement
        window.onload = function() {
            updateStatus('‚úÖ Pr√™t √† ex√©cuter le fix', 'success');
        };
    </script>
</body>
</html>
