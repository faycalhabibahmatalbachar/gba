<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>üñºÔ∏è V√©rification et Correction Images Supabase Storage</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 20px;
        }
        .status-box {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 500;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #f8f9fa;
        }
        .image-card.error {
            border-color: #dc3545;
            background: #ffebee;
        }
        .image-card.success {
            border-color: #28a745;
            background: #e8f5e9;
        }
        .image-preview {
            width: 100%;
            height: 150px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
            background: white;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-fix {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        #logs {
            background: #1e1e1e;
            color: #0ef;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .sql-box {
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .upload-section {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            background: #f8f9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Diagnostic et Correction Images Supabase Storage</h1>
        
        <div id="status" class="status-box info">
            Initialisation du diagnostic des images...
        </div>

        <div class="center">
            <button class="btn" onclick="checkAllImages()">
                üîç V√©rifier toutes les images
            </button>
            <button class="btn btn-fix" onclick="fixImageUrls()">
                üîß Corriger les URLs dans la base
            </button>
            <button class="btn" onclick="checkStorageBucket()">
                üì¶ V√©rifier le bucket Storage
            </button>
        </div>

        <div id="imageGrid" class="image-grid"></div>

        <div class="sql-box" id="sqlFix" style="display: none;">
-- Script de correction des URLs d'images
-- Ce script sera g√©n√©r√© apr√®s le diagnostic
        </div>

        <div id="logs"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uvlrgwdbjegoavjfdrzb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bHJnd2RiamVnb2F2amZkcnpiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1NjU1MzgsImV4cCI6MjA0ODE0MTUzOH0.6ViPt2-gvMGnCKKzyIa0C6JRM4HQQloYLknpF0LNqX4';

        const problematicImages = [
            { name: 'Samsung Galaxy S24 Ultra', file: 'samsung-s24.jpg' },
            { name: 'MacBook Pro 14"', file: 'macbook.jpg' },
            { name: 'iPhone 15 Pro Max', file: 'iphone15.jpg' }
        ];

        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4CAF50' : '#0ef';
            logs.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = 'status-box ' + type;
            status.textContent = message;
            addLog(message, type);
        }

        async function checkStorageBucket() {
            showStatus('V√©rification du bucket Supabase Storage...', 'info');
            
            try {
                // Lister les fichiers dans le bucket products
                const response = await fetch(`${SUPABASE_URL}/storage/v1/object/list/products`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    const files = await response.json();
                    addLog(`‚úÖ Bucket 'products' accessible`, 'success');
                    addLog(`üìÅ ${files.length} fichiers trouv√©s dans le bucket`, 'info');
                    
                    // Afficher les fichiers trouv√©s
                    files.forEach(file => {
                        addLog(`  - ${file.name} (${file.metadata?.size || 'N/A'} bytes)`, 'info');
                    });

                    // V√©rifier si les images probl√©matiques existent
                    problematicImages.forEach(img => {
                        const exists = files.some(f => f.name === img.file);
                        if (!exists) {
                            addLog(`‚ùå Image manquante: ${img.file}`, 'error');
                        } else {
                            addLog(`‚úÖ Image trouv√©e: ${img.file}`, 'success');
                        }
                    });
                } else {
                    const error = await response.text();
                    addLog(`‚ùå Erreur acc√®s bucket: ${error}`, 'error');
                    
                    // Essayer de cr√©er le bucket s'il n'existe pas
                    await createStorageBucket();
                }
            } catch (error) {
                addLog(`‚ùå Erreur: ${error.message}`, 'error');
            }
        }

        async function createStorageBucket() {
            addLog('Tentative de cr√©ation du bucket products...', 'info');
            
            const sqlQuery = `
                -- Cr√©er le bucket s'il n'existe pas
                INSERT INTO storage.buckets (id, name, public)
                VALUES ('products', 'products', true)
                ON CONFLICT (id) DO NOTHING;
            `;

            showStatus('‚ö†Ô∏è Le bucket doit √™tre cr√©√© manuellement dans Supabase Dashboard', 'warning');
            
            document.getElementById('sqlFix').style.display = 'block';
            document.getElementById('sqlFix').textContent = sqlQuery;
        }

        async function checkAllImages() {
            showStatus('V√©rification de toutes les images produits...', 'info');
            const grid = document.getElementById('imageGrid');
            grid.innerHTML = '';

            try {
                // R√©cup√©rer tous les produits
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (response.ok) {
                    const products = await response.json();
                    addLog(`üì¶ ${products.length} produits trouv√©s`, 'info');

                    for (const product of products) {
                        const card = document.createElement('div');
                        card.className = 'image-card';
                        
                        // Tester l'URL de l'image
                        const imageUrl = product.image_url;
                        let imageStatus = 'error';
                        let statusText = '‚ùå Erreur';

                        if (imageUrl) {
                            try {
                                const imgResponse = await fetch(imageUrl, { method: 'HEAD' });
                                if (imgResponse.ok) {
                                    imageStatus = 'success';
                                    statusText = '‚úÖ OK';
                                    addLog(`‚úÖ Image OK: ${product.name}`, 'success');
                                } else {
                                    addLog(`‚ùå HTTP ${imgResponse.status}: ${product.name} - ${imageUrl}`, 'error');
                                    statusText = `‚ùå HTTP ${imgResponse.status}`;
                                }
                            } catch (e) {
                                addLog(`‚ùå Erreur r√©seau: ${product.name}`, 'error');
                                statusText = '‚ùå Erreur r√©seau';
                            }
                        } else {
                            addLog(`‚ö†Ô∏è Pas d'URL: ${product.name}`, 'warning');
                            statusText = '‚ö†Ô∏è Pas d\'URL';
                        }

                        card.className = `image-card ${imageStatus}`;
                        card.innerHTML = `
                            <h4>${product.name}</h4>
                            <p>ID: ${product.id}</p>
                            <img src="${imageUrl || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="100" height="100"%3E%3Crect width="100" height="100" fill="%23ddd"/%3E%3Ctext x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23999"%3EPas d\'image%3C/text%3E%3C/svg%3E'}" 
                                 class="image-preview" 
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"100\" height=\"100\"%3E%3Crect width=\"100\" height=\"100\" fill=\"%23ddd\"/%3E%3Ctext x=\"50%\" y=\"50%\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\"%3EErreur%3C/text%3E%3C/svg%3E'">
                            <p>${statusText}</p>
                            <small style="word-break: break-all;">${imageUrl || 'N/A'}</small>
                        `;
                        
                        grid.appendChild(card);
                    }

                    showStatus('V√©rification termin√©e', 'info');
                } else {
                    const error = await response.text();
                    showStatus(`Erreur r√©cup√©ration produits: ${error}`, 'error');
                }
            } catch (error) {
                showStatus(`Erreur: ${error.message}`, 'error');
            }
        }

        async function fixImageUrls() {
            showStatus('G√©n√©ration du script de correction...', 'info');
            
            const sqlFix = `
-- ========================================
-- CORRECTION DES URLs D'IMAGES PRODUITS
-- ========================================

-- 1. Corriger les images avec erreur 400 (fichiers manquants)
-- Utiliser des URLs alternatives ou des placeholders

UPDATE products 
SET image_url = 'https://via.placeholder.com/400x400/667eea/ffffff?text=Samsung+S24'
WHERE name = 'Samsung Galaxy S24 Ultra' 
AND image_url LIKE '%samsung-s24.jpg%';

UPDATE products 
SET image_url = 'https://via.placeholder.com/400x400/764ba2/ffffff?text=MacBook+Pro'
WHERE name = 'MacBook Pro 14"' 
AND image_url LIKE '%macbook.jpg%';

UPDATE products 
SET image_url = 'https://via.placeholder.com/400x400/f093fb/ffffff?text=iPhone+15'
WHERE name = 'iPhone 15 Pro Max' 
AND image_url LIKE '%iphone15.jpg%';

-- 2. Alternative: Utiliser des images publiques de remplacement
UPDATE products 
SET image_url = 'https://images.unsplash.com/photo-1610945415295-d9bbf067e59c?w=400'
WHERE name = 'Samsung Galaxy S24 Ultra' 
AND image_url LIKE '%samsung-s24.jpg%';

UPDATE products 
SET image_url = 'https://images.unsplash.com/photo-1517336714731-489689fd1ca4?w=400'
WHERE name = 'MacBook Pro 14"' 
AND image_url LIKE '%macbook.jpg%';

UPDATE products 
SET image_url = 'https://images.unsplash.com/photo-1592899677977-9c10ca588bbd?w=400'
WHERE name = 'iPhone 15 Pro Max' 
AND image_url LIKE '%iphone15.jpg%';

-- 3. V√©rifier les r√©sultats
SELECT id, name, image_url 
FROM products 
WHERE name IN ('Samsung Galaxy S24 Ultra', 'MacBook Pro 14"', 'iPhone 15 Pro Max');
`;

            document.getElementById('sqlFix').style.display = 'block';
            document.getElementById('sqlFix').textContent = sqlFix;
            
            showStatus('Script SQL g√©n√©r√©. Ex√©cutez-le dans Supabase SQL Editor', 'success');
            
            // Cr√©er un fichier SQL
            const blob = new Blob([sqlFix], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fix_product_images.sql';
            a.click();
            
            addLog('üìÑ Fichier SQL t√©l√©charg√©: fix_product_images.sql', 'success');
        }

        // Lancer la v√©rification au chargement
        window.onload = () => {
            showStatus('Pr√™t pour le diagnostic des images', 'info');
            checkStorageBucket();
        };
    </script>
</body>
</html>
